<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medieval Quest</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        :root {
            --parchment: #f5e7c1;
            --parchment-dark: #e5d7b1;
            --ink: #3a3121;
            --gold: #d4af37;
            --red: #8b0000;
            --green: #006400;
            --brown-dark: #1a120b;
            --brown-medium: #3a2c1a;
            --brown-light: #e6d5b8;
            --wood-border: #8b4513;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'MedievalSharp', cursive;
            background-color: var(--brown-dark);
            color: var(--brown-light);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            background-image: url('https://www.transparenttextures.com/patterns/old-map.png');
            min-height: 100vh;
        }

        .game-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--brown-medium);
            border: 15px solid transparent;
            border-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png') 30 round;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            padding: 20px;
        }

        .header {
            text-align: center;
            border-bottom: 3px solid var(--wood-border);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        h1 {
            color: var(--gold);
            text-shadow: 2px 2px 4px #000;
            margin: 0;
            font-size: 2.5rem;
            letter-spacing: 2px;
        }

        .player-stats {
            display: flex;
            justify-content: space-around;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat {
            text-align: center;
            min-width: 100px;
        }

        .stat-label {
            color: var(--gold);
            font-size: 0.9rem;
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .story-area {
            background-color: rgba(42, 32, 21, 0.8);
            padding: 20px;
            border-radius: 5px;
            min-height: 200px;
            margin-bottom: 20px;
            border: 1px solid var(--wood-border);
            font-size: 1.1rem;
        }

        .choices-area {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .choice-btn {
            background-color: var(--brown-medium);
            color: var(--brown-light);
            border: 2px solid var(--wood-border);
            padding: 15px;
            font-family: 'MedievalSharp', cursive;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            text-align: left;
        }

        .choice-btn:hover {
            background-color: var(--wood-border);
            transform: translateX(5px);
        }

        .choice-btn:disabled {
            background-color: #2a2015;
            color: #6b5b4b;
            border-color: #6b5b4b;
            cursor: not-allowed;
            transform: none;
        }

        .inventory-area {
            background-color: rgba(42, 32, 21, 0.8);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid var(--wood-border);
            margin-bottom: 20px;
        }

        .inventory-title {
            color: var(--gold);
            margin-top: 0;
            border-bottom: 2px solid var(--wood-border);
            padding-bottom: 5px;
            text-align: center;
        }

        .inventory-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .inventory-item {
            background-color: var(--brown-medium);
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid var(--wood-border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .inventory-item:hover {
            background-color: var(--wood-border);
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding-top: 15px;
            border-top: 2px solid var(--wood-border);
        }

        .control-btn {
            background-color: var(--wood-border);
            color: #fff;
            border: none;
            padding: 12px 25px;
            font-family: 'MedievalSharp', cursive;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background-color: #a05a28;
            transform: scale(1.05);
        }

        .npc-portrait {
            width: 100px;
            height: 100px;
            border: 3px solid var(--wood-border);
            border-radius: 50%;
            margin: 0 auto 15px;
            background-color: #2a2015;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--gold);
        }

        .merchant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px dashed var(--wood-border);
            margin-bottom: 5px;
        }

        .merchant-item:last-child {
            border-bottom: none;
        }

        .character-creation {
            text-align: center;
        }

        .character-option {
            display: inline-block;
            margin: 15px;
            cursor: pointer;
            transition: all 0.3s;
            width: 120px;
        }

        .character-option:hover {
            transform: scale(1.1);
        }

        .char-portrait {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #2a2015;
            border: 3px solid var(--gold);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }

        .char-name-input {
            background: #2a2015;
            border: 2px solid var(--wood-border);
            color: var(--brown-light);
            padding: 10px;
            font-family: 'MedievalSharp', cursive;
            margin: 15px auto;
            width: 250px;
            display: block;
            font-size: 1.1rem;
            text-align: center;
        }

        .quest-log {
            background-color: rgba(42, 32, 21, 0.8);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid var(--wood-border);
            margin-top: 20px;
        }

        .quest-title {
            color: var(--gold);
            border-bottom: 1px solid var(--wood-border);
            padding-bottom: 5px;
        }

        .quest-entry {
            margin-bottom: 10px;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 100;
            animation: fadeInOut 3s ease-in-out;
            display: none;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; top: 10px; }
            10% { opacity: 1; top: 20px; }
            90% { opacity: 1; top: 20px; }
            100% { opacity: 0; top: 10px; }
        }

        @media (max-width: 600px) {
            .character-option {
                margin: 10px;
                width: 100px;
            }
            
            .char-portrait {
                width: 80px;
                height: 80px;
                font-size: 2.5rem;
            }
            
            .stat {
                min-width: 80px;
            }
            
            .game-container {
                padding: 10px;
            }
            
            .choice-btn {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>
    
    <div class="game-container">
        <div class="header">
            <h1>MEDIEVAL QUEST</h1>
            <div class="player-stats">
                <div class="stat">
                    <div class="stat-label">Name</div>
                    <div class="stat-value" id="player-name">-</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Class</div>
                    <div class="stat-value" id="player-class">-</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Gold</div>
                    <div class="stat-value" id="gold">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Reputation</div>
                    <div class="stat-value" id="reputation">-</div>
                </div>
            </div>
        </div>
        
        <div class="story-area" id="story">
            <!-- Content loaded by JavaScript -->
        </div>
        
        <div class="choices-area" id="choices">
            <!-- Choices loaded by JavaScript -->
        </div>
        
        <div class="inventory-area">
            <h3 class="inventory-title">INVENTORY <span id="gold-display">(0 gold)</span></h3>
            <div class="inventory-items" id="inventory">
                <!-- Items loaded by JavaScript -->
            </div>
        </div>
        
        <div class="quest-log" id="quest-log">
            <h3 class="quest-title">ACTIVE QUESTS</h3>
            <div id="quest-entries">
                <!-- Quests loaded by JavaScript -->
            </div>
        </div>
        
        <div class="game-controls">
            <button class="control-btn" id="save-btn">SAVE GAME</button>
            <button class="control-btn" id="load-btn">LOAD GAME</button>
            <button class="control-btn" id="reset-btn">NEW GAME</button>
        </div>
    </div>

    <script>
        // Game Data
        const gameData = {
            currentScene: 'character_creation',
            player: {
                name: "",
                class: "",
                gold: 0,
                reputation: 50,
                inventory: [],
                stats: {
                    strength: 5,
                    agility: 5,
                    intelligence: 5,
                    charisma: 5,
                    defense: 0,
                    wisdom: 0
                },
                quests: [],
                flags: {}
            },
            items: {
                health_potion: {
                    id: "health_potion",
                    name: "Health Potion",
                    description: "Restores 20 health when consumed",
                    type: "consumable",
                    value: 30
                },
                dagger: {
                    id: "dagger",
                    name: "Iron Dagger",
                    description: "Small but deadly (Damage +3)",
                    type: "weapon",
                    value: 50,
                    damage: 3
                },
                cloak: {
                    id: "cloak",
                    name: "Wool Cloak",
                    description: "Provides basic protection (Defense +2)",
                    type: "armor",
                    value: 40,
                    defense: 2
                },
                sword: {
                    id: "sword",
                    name: "Steel Sword",
                    description: "A well-made weapon (Damage +5)",
                    type: "weapon",
                    value: 80,
                    damage: 5
                },
                herbs: {
                    id: "herbs",
                    name: "Medicinal Herbs",
                    description: "Can be used to make potions",
                    type: "material",
                    value: 10
                }
            },
            npcs: {
                bartender: {
                    name: "Gareth",
                    portrait: "🍺",
                    relationship: 50,
                    dialogue: {
                        default: {
                            greeting: "'What'll you have?'",
                            options: [
                                {
                                    text: "Any work available?",
                                    response: "'Aye, I might have something for you...'",
                                    nextScene: "bartender_quest"
                                },
                                {
                                    text: "Just a drink (2 gold)",
                                    response: "'Here you go. That'll be 2 gold.'",
                                    effects: { gold: -2 },
                                    requires: { gold: 2 }
                                },
                                {
                                    text: "Who hangs around here?",
                                    response: "'All sorts. Mercenaries, travelers, the occasional shady character.'"
                                },
                                {
                                    text: "Goodbye",
                                    nextScene: "tavern"
                                }
                            ]
                        },
                        quest_active: {
                            greeting: "'Back so soon? Find Thom's sword yet?'",
                            options: [
                                {
                                    text: "Still working on it",
                                    response: "'Well don't take too long about it.'"
                                },
                                {
                                    text: "I have the sword!",
                                    nextScene: "return_sword",
                                    requires: { item: "sword" }
                                },
                                {
                                    text: "Goodbye",
                                    nextScene: "tavern"
                                }
                            ]
                        }
                    }
                },
                merchant: {
                    name: "Old Thom",
                    portrait: "💰",
                    relationship: 40,
                    dialogue: {
                        default: {
                            greeting: "'Welcome to my humble shop. What can I do for you?'",
                            options: [
                                {
                                    text: "Show me your wares",
                                    response: "'Of course! Take a look...'",
                                    nextScene: "merchant_shop"
                                },
                                {
                                    text: "What's new in town?",
                                    response: "'I heard the blacksmith got a shipment of rare metals from the mountains.'"
                                },
                                {
                                    text: "Goodbye",
                                    nextScene: "market_square"
                                }
                            ]
                        }
                    }
                },
                blacksmith: {
                    name: "Hrothgar",
                    portrait: "⚒️",
                    relationship: 30,
                    dialogue: {
                        default: {
                            greeting: "'Hail traveler! Need weapons or armor?'",
                            options: [
                                {
                                    text: "What do you have for sale?",
                                    response: "'Fine steel weapons and sturdy armor. Take a look.'",
                                    nextScene: "blacksmith_shop"
                                },
                                {
                                    text: "I hear you got special metals",
                                    response: "'Aye, but those are for serious craftsmen. You don't look the type.'",
                                    requires: { quest: "mining_troubles" }
                                },
                                {
                                    text: "Goodbye",
                                    nextScene: "market_square"
                                }
                            ]
                        }
                    }
                }
            },
            quests: {
                stolen_sword: {
                    id: "stolen_sword",
                    name: "Stolen Sword",
                    description: "Recover Thom's stolen sword from the bandits at the old mill",
                    reward: { gold: 50, reputation: 10 },
                    stages: [
                        "Find the bandits' hideout",
                        "Recover Thom's sword",
                        "Return the sword to Gareth"
                    ]
                },
                mining_troubles: {
                    id: "mining_troubles",
                    name: "Mining Troubles",
                    description: "Investigate why the iron shipments from the mines have stopped",
                    reward: { gold: 100, reputation: 20, items: ["sword"] },
                    stages: [
                        "Talk to the miners",
                        "Find out what's blocking the mine",
                        "Report back to Hrothgar"
                    ]
                }
            },
            scenes: {
                character_creation: {
                    id: 'character_creation',
                    text: `
                        <div class='character-creation'>
                            <h2>BEGIN YOUR ADVENTURE</h2>
                            <p>The realm of Eldermere needs heroes. Choose your path:</p>
                        </div>
                    `,
                    choices: [
                        {
                            text: `
                                <div class='character-option'>
                                    <div class='char-portrait'>⚔️</div>
                                    <div>Warrior</div>
                                    <small>+2 Strength, +1 Defense</small>
                                </div>
                            `,
                            nextScene: "name_selection",
                            effects: { 
                                class: "Warrior", 
                                strength: 2,
                                agility: -1,
                                defense: 1 
                            }
                        },
                        {
                            text: `
                                <div class='character-option'>
                                    <div class='char-portrait'>🏹</div>
                                    <div>Rogue</div>
                                    <small>+2 Agility, +1 Charisma</small>
                                </div>
                            `,
                            nextScene: "name_selection",
                            effects: { 
                                class: "Rogue", 
                                agility: 2,
                                strength: -1,
                                charisma: 1 
                            }
                        },
                        {
                            text: `
                                <div class='character-option'>
                                    <div class='char-portrait'>🔮</div>
                                    <div>Mage</div>
                                    <small>+2 Intelligence, +1 Wisdom</small>
                                </div>
                            `,
                            nextScene: "name_selection",
                            effects: { 
                                class: "Mage", 
                                intelligence: 2,
                                strength: -1,
                                wisdom: 1 
                            }
                        }
                    ]
                },
                name_selection: {
                    id: 'name_selection',
                    text: `
                        <div class='character-creation'>
                            <h2>WHAT IS YOUR NAME?</h2>
                            <input type='text' id='name-input' class='char-name-input' placeholder='Enter your name' maxlength="20">
                            <p>A name that will be remembered throughout the realm!</p>
                        </div>
                    `,
                    choices: [
                        {
                            text: "BEGIN ADVENTURE",
                            nextScene: "game_start",
                            action: "setName"
                        }
                    ]
                },
                game_start: {
                    id: 'game_start',
                    text: function() {
                        return `
                            <p>You stand at the gates of Briarwood, a bustling village on the edge of the kingdom. The sun shines brightly as merchants call out their wares and townsfolk go about their daily business.</p>
                            <p>As ${gameData.player.name} the ${gameData.player.class}, you've come seeking adventure and fortune. Where will you begin?</p>
                        `;
                    },
                    choices: [
                        { 
                            text: "Enter the village", 
                            nextScene: "village_square",
                            effects: { gold: 50 } // Starting gold
                        },
                        { 
                            text: "Visit the nearby tavern", 
                            nextScene: "tavern" 
                        },
                        { 
                            text: "Check your equipment", 
                            nextScene: "inventory_check" 
                        }
                    ]
                },
                village_square: {
                    id: 'village_square',
                    text: `
                        <p>The village square is alive with activity. Farmers sell their produce, children play near the fountain, and guards patrol the perimeter.</p>
                        <p>Several establishments surround the square:</p>
                        <ul>
                            <li>The Rusty Tankard tavern</li>
                            <li>Old Thom's General Goods</li>
                            <li>Hrothgar's Smithy</li>
                            <li>The town notice board</li>
                        </ul>
                    `,
                    choices: [
                        { text: "Go to the tavern", nextScene: "tavern" },
                        { text: "Visit the merchant", nextScene: "merchant_shop" },
                        { text: "Check the blacksmith", nextScene: "blacksmith" },
                        { text: "Examine the notice board", nextScene: "notice_board" },
                        { text: "Leave the village", nextScene: "countryside" }
                    ]
                },
                tavern: {
                    id: 'tavern',
                    text: `
                        <div class='npc-portrait'>🍺</div>
                        <p>The Rusty Tankard is warm and lively, filled with the smell of roasted meat and ale. A bard plays in the corner as patrons laugh and drink.</p>
                        <p>The bartender notices you enter and waves you over.</p>
                    `,
                    choices: [
                        { 
                            text: "Talk to the bartender", 
                            nextScene: "bartender_talk" 
                        },
                        { 
                            text: "Listen to the bard's tales", 
                            nextScene: "bard_tales",
                            effects: { intelligence: 1 } 
                        },
                        { 
                            text: "Look for work", 
                            nextScene: "tavern_work" 
                        },
                        { 
                            text: "Return to village square", 
                            nextScene: "village_square" 
                        }
                    ]
                },
                bartender_talk: {
                    id: 'bartender_talk',
                    text: `
                        <div class='npc-portrait'>🍺</div>
                        <p>The bartender wipes down the counter as you approach.</p>
                        <p><b>Gareth:</b> "${gameData.player.quests.includes('stolen_sword') ? 
                            'Back so soon? Find Thom\'s sword yet?' : 
                            'What\'ll you have?'}"</p>
                    `,
                    choices: function() {
                        if (gameData.player.quests.includes('stolen_sword')) {
                            return [
                                {
                                    text: "Still working on it",
                                    response: "'Well don't take too long about it.'",
                                    nextScene: "tavern"
                                },
                                {
                                    text: "I have the sword!",
                                    nextScene: "return_sword",
                                    requires: { item: "sword" }
                                },
                                {
                                    text: "Goodbye",
                                    nextScene: "tavern"
                                }
                            ];
                        } else {
                            return [
                                {
                                    text: "Any work available?",
                                    response: "'Aye, I might have something for you...'",
                                    nextScene: "bartender_quest"
                                },
                                {
                                    text: "Just a drink (2 gold)",
                                    response: "'Here you go. That'll be 2 gold.'",
                                    effects: { gold: -2 },
                                    requires: { gold: 2 },
                                    nextScene: "tavern"
                                },
                                {
                                    text: "Who hangs around here?",
                                    response: "'All sorts. Mercenaries, travelers, the occasional shady character.'",
                                    nextScene: "bartender_talk"
                                },
                                {
                                    text: "Goodbye",
                                    nextScene: "tavern"
                                }
                            ];
                        }
                    }
                },
                bartender_quest: {
                    id: 'bartender_quest',
                    text: `
                        <div class='npc-portrait'>🍺</div>
                        <p><b>Gareth:</b> "Old Thom had his sword stolen last night by some ruffians. Bring it back and there's 50 gold in it for you."</p>
                        <p>He leans in closer. "They were last seen heading toward the old mill northeast of town."</p>
                    `,
                    choices: [
                        {
                            text: "Accept the quest",
                            nextScene: "sword_quest_accepted",
                            action: "addQuest:stolen_sword"
                        },
                        {
                            text: "Ask for more information",
                            nextScene: "sword_quest_info"
                        },
                        {
                            text: "Decline politely",
                            nextScene: "tavern",
                            effects: { reputation: -1 }
                        }
                    ]
                },
                sword_quest_accepted: {
                    id: 'sword_quest_accepted',
                    text: `
                        <p>You've agreed to retrieve Thom's stolen sword. The old mill northeast of town would be a likely hideout for bandits.</p>
                        <p>How will you prepare for this task?</p>
                    `,
                    choices: [
                        {
                            text: "Go directly to the mill",
                            nextScene: "mill_approach"
                        },
                        {
                            text: "Buy supplies first (30 gold)",
                            nextScene: "merchant_shop",
                            requires: { gold: 30 }
                        },
                        {
                            text: "Try to recruit help in the tavern",
                            nextScene: "recruit_help",
                            requires: { charisma: 6 }
                        },
                        {
                            text: "Return to village square",
                            nextScene: "village_square"
                        }
                    ]
                },
                merchant_shop: {
                    id: 'merchant_shop',
                    text: `
                        <div class='npc-portrait'>💰</div>
                        <p><b>Old Thom:</b> "Here's what I have for sale today:"</p>
                        <div class='merchant-item'><span>Health Potion</span><span>30 gold</span></div>
                        <div class='merchant-item'><span>Iron Dagger</span><span>50 gold</span></div>
                        <div class='merchant-item'><span>Wool Cloak</span><span>40 gold</span></div>
                    `,
                    choices: [
                        {
                            text: "Buy Health Potion (30 gold)",
                            nextScene: "buy_item",
                            action: "buy:health_potion",
                            requires: { gold: 30 }
                        },
                        {
                            text: "Buy Iron Dagger (50 gold)",
                            nextScene: "buy_item",
                            action: "buy:dagger",
                            requires: { gold: 50 }
                        },
                        {
                            text: "Buy Wool Cloak (40 gold)",
                            nextScene: "buy_item",
                            action: "buy:cloak",
                            requires: { gold: 40 }
                        },
                        {
                            text: "Ask about the stolen sword",
                            nextScene: "ask_about_sword",
                            requires: { quest: "stolen_sword" }
                        },
                        {
                            text: "Leave",
                            nextScene: "village_square"
                        }
                    ]
                },
                buy_item: {
                    id: 'buy_item',
                    text: `
                        <div class='npc-portrait'>💰</div>
                        <p><b>Old Thom:</b> "A fine choice! Anything else?"</p>
                    `,
                    choices: [
                        {
                            text: "Continue shopping",
                            nextScene: "merchant_shop"
                        },
                        {
                            text: "Leave",
                            nextScene: "village_square"
                        }
                    ]
                },
                return_sword: {
                    id: 'return_sword',
                    text: `
                        <div class='npc-portrait'>🍺</div>
                        <p><b>Gareth:</b> "You found it! Thom will be pleased. Here's your reward as promised."</p>
                        <p>He hands you a small pouch of coins.</p>
                    `,
                    effects: {
                        gold: 50,
                        reputation: 10,
                        removeItem: "sword",
                        completeQuest: "stolen_sword"
                    },
                    choices: [
                        {
                            text: "Ask about other work",
                            nextScene: "more_work"
                        },
                        {
                            text: "Thank him and leave",
                            nextScene: "tavern"
                        }
                    ]
                }
            }
        };

        // Game Functions
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function loadScene(sceneId) {
            try {
                const scene = gameData.scenes[sceneId];
                if (!scene) throw new Error(`Scene ${sceneId} not found!`);
                
                gameData.currentScene = sceneId;
                
                // Process scene text (could be string or function)
                let sceneText = typeof scene.text === 'function' ? scene.text() : scene.text;
                document.getElementById('story').innerHTML = sceneText;
                
                // Process scene choices (could be array or function)
                let sceneChoices = typeof scene.choices === 'function' ? scene.choices() : scene.choices;
                
                const choicesContainer = document.getElementById('choices');
                choicesContainer.innerHTML = '';
                
                if (sceneChoices && sceneChoices.length > 0) {
                    sceneChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.innerHTML = choice.text;
                        button.onclick = () => makeChoice(choice);
                        
                        // Disable if requirements not met
                        if (choice.requires && !hasRequirements(choice.requires)) {
                            button.disabled = true;
                        }
                        
                        choicesContainer.appendChild(button);
                    });
                } else {
                    // If no choices, provide a default continue button
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue";
                    button.onclick = () => loadScene('village_square'); // Default return to village
                    choicesContainer.appendChild(button);
                }
                
                // Apply any scene effects
                if (scene.effects) {
                    const effects = typeof scene.effects === 'function' ? scene.effects() : scene.effects;
                    applyEffects(effects);
                }
                
                updateUI();
            } catch (error) {
                console.error("Scene loading error:", error);
                document.getElementById('story').innerHTML = `
                    <p>Error loading scene. Please refresh.</p>
                    <p><small>${error.message}</small></p>
                `;
            }
        }

        function makeChoice(choice) {
            // Handle choice action if present
            if (choice.action) {
                handleAction(choice.action);
            }
            
            // Apply any immediate effects
            if (choice.effects) {
                applyEffects(choice.effects);
            }
            
            // Show response if present before continuing
            if (choice.response) {
                document.getElementById('story').innerHTML += `<p><b>${getCurrentNPC()?.name || 'NPC'}:</b> "${choice.response}"</p>`;
                
                // If there's a next scene, add a continue button
                if (choice.nextScene) {
                    const choicesContainer = document.getElementById('choices');
                    choicesContainer.innerHTML = '';
                    
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue";
                    button.onclick = () => loadScene(choice.nextScene);
                    choicesContainer.appendChild(button);
                }
            } 
            // Otherwise proceed to next scene
            else if (choice.nextScene) {
                loadScene(choice.nextScene);
            }
            
            updateUI();
        }

        function handleAction(action) {
            const [actionType, actionParam] = action.split(':');
            
            switch(actionType) {
                case 'setName':
                    const nameInput = document.getElementById('name-input');
                    if (nameInput && nameInput.value.trim() !== '') {
                        gameData.player.name = nameInput.value.trim();
                    } else {
                        gameData.player.name = "Unknown Adventurer";
                    }
                    break;
                    
                case 'buy':
                    if (gameData.player.gold >= gameData.items[actionParam].value) {
                        gameData.player.gold -= gameData.items[actionParam].value;
                        gameData.player.inventory.push(actionParam);
                        showNotification(`Purchased: ${gameData.items[actionParam].name}`);
                    }
                    break;
                    
                case 'addQuest':
                    if (!gameData.player.quests.includes(actionParam)) {
                        gameData.player.quests.push(actionParam);
                        showNotification(`New Quest: ${gameData.quests[actionParam].name}`);
                    }
                    break;
            }
        }

        function applyEffects(effects) {
            if (!effects) return;
            
            if (effects.gold) {
                gameData.player.gold += effects.gold;
                if (effects.gold > 0) {
                    showNotification(`Received ${effects.gold} gold!`);
                } else {
                    showNotification(`Spent ${-effects.gold} gold.`);
                }
            }
            
            if (effects.reputation) {
                gameData.player.reputation += effects.reputation;
                gameData.player.reputation = Math.max(0, Math.min(100, gameData.player.reputation));
                showNotification(`Reputation ${effects.reputation > 0 ? 'increased' : 'decreased'}!`);
            }
            
            if (effects.addItem) {
                gameData.player.inventory.push(effects.addItem);
                showNotification(`Obtained: ${gameData.items[effects.addItem]?.name || effects.addItem}`);
            }
            
            if (effects.removeItem) {
                const index = gameData.player.inventory.indexOf(effects.removeItem);
                if (index > -1) {
                    gameData.player.inventory.splice(index, 1);
                }
            }
            
            if (effects.completeQuest) {
                const index = gameData.player.quests.indexOf(effects.completeQuest);
                if (index > -1) {
                    gameData.player.quests.splice(index, 1);
                    showNotification(`Quest Completed: ${gameData.quests[effects.completeQuest]?.name || effects.completeQuest}`);
                }
            }
            
            // Handle stat changes
            ['strength', 'agility', 'intelligence', 'charisma', 'defense', 'wisdom'].forEach(stat => {
                if (effects[stat]) {
                    gameData.player.stats[stat] = (gameData.player.stats[stat] || 0) + effects[stat];
                }
            });
            
            updateUI();
        }

        function hasRequirements(requirements) {
            if (!requirements) return true;
            
            for (const [key, value] of Object.entries(requirements)) {
                if (key === 'gold' && gameData.player.gold < value) return false;
                if (key === 'reputation' && gameData.player.reputation < value) return false;
                if (key === 'item' && !gameData.player.inventory.includes(value)) return false;
                if (key === 'quest' && !gameData.player.quests.includes(value)) return false;
                if (key in gameData.player.stats && gameData.player.stats[key] < value) return false;
            }
            return true;
        }

        function getCurrentNPC() {
            // Check if current scene is related to an NPC
            const scene = gameData.scenes[gameData.currentScene];
            if (scene && (scene.id.includes('_talk') || scene.id.includes('_shop'))) {
                const npcId = scene.id.split('_')[0];
                return gameData.npcs[npcId];
            }
            return null;
        }

        function updateUI() {
            // Update player info
            document.getElementById('player-name').textContent = gameData.player.name || "-";
            document.getElementById('player-class').textContent = gameData.player.class || "-";
            document.getElementById('gold').textContent = gameData.player.gold;
            document.getElementById('reputation').textContent = getReputationText(gameData.player.reputation);
            document.getElementById('gold-display').textContent = `(${gameData.player.gold} gold)`;
            
            // Update inventory
            const inventoryContainer = document.getElementById('inventory');
            inventoryContainer.innerHTML = '';
            
            gameData.player.inventory.forEach(itemId => {
                const item = gameData.items[itemId];
                if (item) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item.name;
                    itemElement.title = item.description;
                    inventoryContainer.appendChild(itemElement);
                }
            });
            
            // Update quest log
            const questLog = document.getElementById('quest-entries');
            questLog.innerHTML = '';
            
            if (gameData.player.quests.length === 0) {
                questLog.innerHTML = '<p>No active quests</p>';
            } else {
                gameData.player.quests.forEach(questId => {
                    const quest = gameData.quests[questId];
                    if (quest) {
                        const questElement = document.createElement('div');
                        questElement.className = 'quest-entry';
                        questElement.innerHTML = `
                            <p><b>${quest.name}</b></p>
                            <p>${quest.description}</p>
                        `;
                        questLog.appendChild(questElement);
                    }
                });
            }
        }

        function getReputationText(reputation) {
            if (reputation < 20) return "Hated";
            if (reputation < 40) return "Disliked";
            if (reputation < 60) return "Neutral";
            if (reputation < 80) return "Liked";
            return "Revered";
        }

        function saveGame() {
            try {
                localStorage.setItem('medievalQuestSave', JSON.stringify(gameData));
                showNotification('Game saved successfully!');
            } catch (error) {
                console.error("Save error:", error);
                showNotification('Failed to save game!');
            }
        }

        function loadGame() {
            try {
                const savedData = localStorage.getItem('medievalQuestSave');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    Object.assign(gameData, parsed);
                    loadScene(gameData.currentScene);
                    showNotification('Game loaded successfully!');
                } else {
                    showNotification('No saved game found!');
                }
            } catch (error) {
                console.error("Load error:", error);
                showNotification('Failed to load game!');
            }
        }

        function resetGame() {
            if (confirm('Are you sure you want to start a new game? All progress will be lost.')) {
                // Reset game data
                gameData.player = {
                    name: "",
                    class: "",
                    gold: 0,
                    reputation: 50,
                    inventory: [],
                    stats: {
                        strength: 5,
                        agility: 5,
                        intelligence: 5,
                        charisma: 5,
                        defense: 0,
                        wisdom: 0
                    },
                    quests: [],
                    flags: {}
                };
                gameData.currentScene = 'character_creation';
                
                // Clear saved game
                localStorage.removeItem('medievalQuestSave');
                
                // Start fresh
                loadScene(gameData.currentScene);
                showNotification('New game started!');
            }
        }

        // Initialize the game
        document.getElementById('save-btn').onclick = saveGame;
        document.getElementById('load-btn').onclick = loadGame;
        document.getElementById('reset-btn').onclick = resetGame;
        
        // Start the game immediately with empty story area
        document.getElementById('story').innerHTML = '';
        loadScene(gameData.currentScene);
    </script>
</body>
</html>
